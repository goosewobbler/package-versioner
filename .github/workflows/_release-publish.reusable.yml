name: Publish Release

on:
  workflow_call:
    inputs:
      release_version:
        description: 'Release type (patch, minor, major, prepatch, preminor, premajor, prerelease)'
        required: true
        type: string
      dry_run:
        description: 'Dry run - no changes made'
        required: true
        default: false
        type: boolean
    secrets:
      npm_token:
        description: 'NPM token for publishing packages'
        required: true
      deploy_key:
        description: 'SSH deploy key for pushing to the repository'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.version.outputs.release_tag }}
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - name: Verify official repository
        if: github.repository != 'goosewobbler/package-versioner'
        run: |
          echo "::error::This workflow can only be run in the official repository (goosewobbler/package-versioner)"
          exit 1

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.deploy_key }}
          ref: main
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/workflows/actions/setup-workspace
        with:
          node-version: '20'

      - name: Build and verify
        uses: ./.github/workflows/actions/build-verify

      - name: Run package-versioner
        id: version
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.release_version }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Build package-versioner arguments
          ARGS=""
          if [[ "$RELEASE_VERSION" == pre* ]]; then
            # Pre-release: extract the base type for --prerelease flag
            if [[ "$RELEASE_VERSION" == "prerelease" ]]; then
              ARGS="--bump patch --prerelease"
            else
              BASE_TYPE="${RELEASE_VERSION#pre}"
              ARGS="--bump $BASE_TYPE --prerelease"
            fi
          else
            ARGS="--bump $RELEASE_VERSION"
          fi

          if [[ "$DRY_RUN" == "true" ]]; then
            ARGS="$ARGS --dry-run"
          fi

          echo "Running: node ./dist/index.js $ARGS"
          OUTPUT=$(node ./dist/index.js $ARGS 2>&1)
          CMD_STATUS=$?
          echo "$OUTPUT"

          if [ $CMD_STATUS -ne 0 ]; then
            echo "::error::Versioning failed with exit code $CMD_STATUS"
            exit 1
          fi

          # Determine version and tag
          if [[ "$DRY_RUN" == "true" ]]; then
            NEW_VERSION=$(echo "$OUTPUT" | grep -o 'to version [0-9][0-9.a-z-]*' | head -n 1 | cut -d' ' -f3)
            RELEASE_TAG=$(echo "$OUTPUT" | grep -o 'Would create tag: [^[:space:]]*' | head -n 1 | cut -d' ' -f4)
          else
            NEW_VERSION=$(jq -r '.version' package.json)
            RELEASE_TAG="v${NEW_VERSION}"
          fi

          if [[ -z "$NEW_VERSION" ]]; then
            echo "::error::Could not determine new version"
            exit 1
          fi

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG:-v$NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Publish to NPM
        if: inputs.dry_run == false
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.npm_token }}
        run: |
          NPM_TAG="latest"
          VERSION="${{ steps.version.outputs.new_version }}"
          if [[ "$VERSION" =~ (beta|alpha|rc|pre|next) ]]; then
            NPM_TAG="next"
          fi

          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          echo "Publishing $VERSION to NPM with tag $NPM_TAG..."
          pnpm publish --tag $NPM_TAG --no-git-checks

      - name: Publish to NPM (dry run)
        if: inputs.dry_run == true
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.npm_token }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          npm whoami || echo "::warning::NPM auth check failed"
          echo "[DRY RUN] Would publish ${{ steps.version.outputs.new_version }} to NPM"

      - name: Push tags and commits
        if: inputs.dry_run == false
        shell: bash
        run: |
          RELEASE_TAG="${{ steps.version.outputs.release_tag }}"
          echo "Pushing tag $RELEASE_TAG and commits to main..."

          git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG" || echo "Tag already exists"
          git push origin "$RELEASE_TAG" --no-verify
          git push origin HEAD:main --no-verify

      - name: Create GitHub release
        if: inputs.dry_run == false
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.release_tag }}
          name: Release ${{ steps.version.outputs.release_tag }}
          prerelease: ${{ contains(inputs.release_version, 'pre') }}

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: ${{ steps.version.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release type: ${{ inputs.release_version }}" >> $GITHUB_STEP_SUMMARY
